<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <title>Kartl√§ggare ‚Äì MapLibre GL (OSM + Orion + Sat, GPX + Track-up)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Tailwind f√∂r UI -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- MapLibre GL -->
  <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
  <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>

  <!-- Turf (distans m.m.) -->
  <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

  <!-- togeojson (GPX -> GeoJSON) -->
  <script src="https://unpkg.com/@tmcw/togeojson/dist/togeojson.umd.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    #map { position: absolute; inset: 0; }

    /* Distans + Export ‚Äúpill‚Äù uppe till v√§nster, strax h√∂ger om +/kontroller */
    #info-panel { position: absolute; top: 10px; left: 56px; z-index: 10; }

    /* V√§nster custom-verktygsrad (under MapLibre-zoom) */
    .left-toolbar {
      position: absolute;
      top: 94px;  /* strax under zoom-knapparna */
      left: 10px;
      z-index: 10;
      display: flex;
      flex-direction: column;
    }
    .tool-btn {
      width: 30px; height: 30px;
      display:flex; align-items:center; justify-content:center;
      background:#fff; border:1px solid #ccc; border-bottom:none;
      color:#464646; font-size:10px; font-weight:400;
      cursor:pointer; user-select:none;
    }
    .tool-btn:last-child { border-bottom: 1px solid #ccc; }
    .tool-btn:hover { background:#f4f4f4; }
    .tool-active { outline:2px solid #60a5fa; outline-offset:-1px; }
    .rot-active { outline:2px solid #34d399; outline-offset:-1px; }

    /* TRK-lista som √∂ppnas till h√∂ger om TRK-knappen */
    .tracks-panel {
      position: absolute;
      z-index: 12;
      background: #fff;
      width: 260px;
      border-radius: .25rem;
      box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -2px rgb(0 0 0 / 0.1);
      display: none;
      max-height: 75vh;
      overflow: auto;
    }
    .tracks-panel.open { display: block; }
    .trk-item { padding: 8px 10px; cursor: pointer; }
    .trk-item:hover { background: #f3f4f6; }
  </style>
</head>
<body>

  <div id="map"></div>

  <!-- Distans + Export -->
  <div id="info-panel">
    <div class="flex items-center gap-3 bg-white/95 backdrop-blur px-4 py-2 rounded-full shadow">
      <span class="text-sm text-red-600 font-bold" id="distance-output">0.00 km</span>
      <button id="export-btn" disabled
        class="px-4 py-1.5 rounded-full text-sm font-semibold text-white bg-black disabled:opacity-50 disabled:cursor-not-allowed">
        Export
      </button>
    </div>
  </div>

  <!-- V√§nster verktygsrad -->
  <div class="left-toolbar" id="leftToolbar">
    <div class="tool-btn" id="btnOpen">Open</div>
    <div class="tool-btn" id="btnTRK">TRK</div>
    <div class="tool-btn" id="btnTrash" title="Rensa sp√•r">üóë</div>
    <div class="tool-btn" id="btnGPS">GPS</div>
    <div class="tool-btn" id="btnROT">ROT</div>
    <div class="tool-btn" id="btnDraw" title="Rita rutt">Draw</div>
  </div>

  <!-- TRK-lista -->
  <div id="tracksPanel" class="tracks-panel">
    <div class="px-3 py-2 text-sm font-semibold border-b border-gray-200">F√∂rdefinierade sp√•r</div>
    <div id="trkList"></div>
  </div>

  <!-- Osynlig filinput f√∂r "Open" -->
  <input type="file" id="fileInput" accept=".gpx,application/gpx+xml,application/xml,text/xml" style="display:none" />

  <script>
  (async function() {
    // --- KONFIG ---
    const MAX_ZOOM = 17;
    const START = { lat: 56.15666, lng: 15.84580, zoom: 15 };

    // Kartk√§llor (raster)
    const OSM_URL   = 'https://tile.openstreetmap.org/{z}/{x}/{y}.png';
    const ESRI_URL  = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
    const ORION_URL = 'https://okorion.com/maptiles/orienteering/wgs84/{z}/{x}/{y}.png';

    // --- STYLEOBJEKT f√∂r MapLibre (rasterbaserat) ---
    const style = {
      "version": 8,
      "name": "Raster base",
      "sources": {
        "osm": {
          "type": "raster",
          "tiles": [ OSM_URL ],
          "tileSize": 256,
          "attribution": "¬© OpenStreetMap-bidragsgivare",
          "maxzoom": MAX_ZOOM
        },
        "esri": {
          "type": "raster",
          "tiles": [ ESRI_URL ],
          "tileSize": 256,
          "attribution": "Imagery ¬© Esri, Maxar, Earthstar Geographics",
          "maxzoom": MAX_ZOOM
        },
        "orion": {
          "type": "raster",
          "tiles": [ ORION_URL ],
          "tileSize": 256,
          "attribution": "¬© OK Orion",
          "maxzoom": MAX_ZOOM
        }
      },
      "layers": [
        { "id": "osm",   "type": "raster", "source": "osm",   "layout": { "visibility": "visible" } },
        { "id": "esri",  "type": "raster", "source": "esri",  "layout": { "visibility": "none"    } },
        { "id": "orion", "type": "raster", "source": "orion", "layout": { "visibility": "visible" } }
      ]
    };

    // --- Skapa karta ---
    const map = new maplibregl.Map({
      container: 'map',
      style,
      center: [START.lng, START.lat],
      zoom: START.zoom,
      pitch: 0,
      bearing: 0,
      dragRotate: false,  // vi styr bearing sj√§lva i ROT-l√§get
      maxZoom: MAX_ZOOM
    });

    // Standard-zoomkontroll (uppe till v√§nster)
    map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'top-left');

    // Lagerbytare (enkel) ‚Äì v√§xlar baslager OSM/Esri, l√§mnar Orion p√•
    function setBase(base) {
      map.setLayoutProperty('osm',  'visibility', base === 'osm'  ? 'visible' : 'none');
      map.setLayoutProperty('esri', 'visibility', base === 'esri' ? 'visible' : 'none');
    }

    // --- Rit- & GPX-k√§llor/lager ---
    // K√§lla/lager f√∂r ritad rutt
    const drawSourceId = 'draw-line-src';
    const drawLayerId  = 'draw-line-lyr';
    const drawPointsId = 'draw-points-src';
    const drawPointsLy = 'draw-points-lyr';

    // Inl√§st GPX (f√∂rdefinierad eller uppladdad)
    const gpxSrcId = 'gpx-src';
    const gpxLyId  = 'gpx-lyr';

    // Platsk√§llor
    const posSrcId  = 'pos-src';
    const accSrcId  = 'acc-src';
    const posLyId   = 'pos-lyr';
    const accLyId   = 'acc-lyr';

    // Tillst√•nd
    let isDrawing = false;
    let drawCoords = []; // [ [lng,lat], ... ]
    let gpxShown = false;
    let followOn = false;
    let rotOn = false;
    let watchId = null;
    let currentHeading = 0;

    // UI-referenser
    const btnOpen  = document.getElementById('btnOpen');
    const btnTRK   = document.getElementById('btnTRK');
    const btnTrash = document.getElementById('btnTrash');
    const btnGPS   = document.getElementById('btnGPS');
    const btnROT   = document.getElementById('btnROT');
    const btnDraw  = document.getElementById('btnDraw');
    const exportBtn = document.getElementById('export-btn');
    const distanceOutput = document.getElementById('distance-output');
    const fileInput = document.getElementById('fileInput');
    const tracksPanel = document.getElementById('tracksPanel');
    const trkList = document.getElementById('trkList');

    function setDistanceKm(km) { distanceOutput.textContent = `${km.toFixed(2)} km`; }
    function computeLengthKmFromCoords(coords) {
      if (!coords || coords.length < 2) return 0;
      const gj = { type: 'Feature', geometry: { type: 'LineString', coordinates: coords }, properties: {} };
      return turf.length(gj, { units: 'kilometers' });
    }
    function refreshExportState() {
      const ok = drawCoords.length >= 2;
      exportBtn.disabled = !ok;
      exportBtn.onclick = ok ? () => exportToGPX(drawCoords) : null;
    }

    map.on('load', () => {
      // Baslager-knappar ‚Äì enkelt exempel (byt i koden om du vill ha UI)
      // setBase('osm'); // default i style

      // K√§llor/lager f√∂r ritad rutt
      map.addSource(drawSourceId, { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
      map.addLayer({
        id: drawLayerId, type: 'line', source: drawSourceId,
        paint: { 'line-color': '#dc2626', 'line-width': 4, 'line-opacity': 0.9 }
      });

      map.addSource(drawPointsId, { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
      map.addLayer({
        id: drawPointsLy, type: 'circle', source: drawPointsId,
        paint: { 'circle-color': '#dc2626', 'circle-radius': 3, 'circle-stroke-color': '#ffffff', 'circle-stroke-width': 1 }
      });

      // GPX-visning
      map.addSource(gpxSrcId, { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
      map.addLayer({
        id: gpxLyId, type: 'line', source: gpxSrcId,
        paint: { 'line-color': '#0ea5e9', 'line-width': 3, 'line-opacity': 0.9 }
      });

      // Position/accuracy
      map.addSource(posSrcId, { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
      map.addLayer({
        id: posLyId, type: 'circle', source: posSrcId,
        paint: { 'circle-color': '#3b82f6', 'circle-radius': 6, 'circle-stroke-color': '#ffffff', 'circle-stroke-width': 2 }
      });

      map.addSource(accSrcId, { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });
      map.addLayer({
        id: accLyId, type: 'fill', source: accSrcId,
        paint: { 'fill-color': '#60a5fa', 'fill-opacity': 0.15, 'fill-outline-color': '#3b82f6' }
      });

      // Klick f√∂r att rita (endast om draw-l√§get √§r aktivt)
      map.on('click', (e) => {
        if (!isDrawing) return;
        const ll = [e.lngLat.lng, e.lngLat.lat];
        drawCoords.push(ll);
        updateDrawLayers();
        setDistanceKm(computeLengthKmFromCoords(drawCoords));
        refreshExportState();
      });
      // Dubbelklick f√∂r att avsluta ritning
      map.on('dblclick', (e) => {
        if (!isDrawing) return;
        isDrawing = false;
        btnDraw.classList.remove('tool-active');
      });

      refreshExportState();
    });

    function updateDrawLayers() {
      // polyline
      const lineFC = drawCoords.length >= 2
        ? { type: 'FeatureCollection', features: [{ type:'Feature', properties:{}, geometry:{ type:'LineString', coordinates: drawCoords } }] }
        : { type: 'FeatureCollection', features: [] };
      map.getSource(drawSourceId).setData(lineFC);

      // punkter
      const pts = drawCoords.map(c => ({ type:'Feature', properties:{}, geometry:{ type:'Point', coordinates:c } }));
      map.getSource(drawPointsId).setData({ type:'FeatureCollection', features: pts });
    }

    // --- Export till GPX (RTE + TRK)
    function exportToGPX(coords) {
      if (!coords || coords.length < 2) return;
      const now = new Date();
      const isoNow = now.toISOString().split('.')[0] + 'Z';
      const routeName = `Rutt_${now.toLocaleDateString('sv-SE')}_${now.toLocaleTimeString('sv-SE',{hour12:false}).replace(/:/g,'-')}`;

      let gpx = `<?xml version="1.0" encoding="UTF-8"?>
<gpx version="1.1"
     creator="Ruttplan-MapLibre"
     xmlns="http://www.topografix.com/GPX/1/1"
     xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
     xsi:schemaLocation="http://www.topografix.com/GPX/1/1
                         http://www.topografix.com/GPX/1/1/gpx.xsd">
  <metadata><name>${routeName}</name><time>${isoNow}</time></metadata>
  <rte><name>${routeName}</name><time>${isoNow}</time>`;
      coords.forEach((c,i) => {
        gpx += `\n    <rtept lat="${c[1].toFixed(6)}" lon="${c[0].toFixed(6)}"><name>P${i+1}</name></rtept>`;
      });
      gpx += `
  </rte>
  <trk><name>${routeName}</name><trkseg>`;
      coords.forEach((c,i) => {
        const t = new Date(now.getTime()+i*1000).toISOString().split('.')[0]+'Z';
        gpx += `\n    <trkpt lat="${c[1].toFixed(6)}" lon="${c[0].toFixed(6)}"><time>${t}</time></trkpt>`;
      });
      gpx += `
    </trkseg></trk>
</gpx>`;

      const blob = new Blob([gpx], { type: 'application/gpx+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = routeName.replace(/ /g,'_') + '.gpx';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // --- Open (ladda lokal GPX) ---
    btnOpen.onclick = () => fileInput.click();
    fileInput.onchange = async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const text = await file.text();
      showGpxText(text);
    };

    // --- TRK (manifest) ---
    btnTRK.onclick = async (e) => {
      e.preventDefault();
      toggleTracksPanel(btnTRK);
    };
    function toggleTracksPanel(anchorBtn) {
      if (tracksPanel.classList.contains('open')) {
        tracksPanel.classList.remove('open');
        return;
      }
      positionPanelRightOf(anchorBtn);
      populateTracksList();
      tracksPanel.classList.add('open');
      const closeOnOutside = (ev) => {
        if (!tracksPanel.contains(ev.target) && ev.target !== anchorBtn) {
          tracksPanel.classList.remove('open');
          document.removeEventListener('click', closeOnOutside);
        }
      };
      setTimeout(() => document.addEventListener('click', closeOnOutside), 0);
    }
    function positionPanelRightOf(anchorBtn) {
      const mapRect = map.getContainer().getBoundingClientRect();
      const r = anchorBtn.getBoundingClientRect();
      tracksPanel.style.top = `${r.top - mapRect.top}px`;
      tracksPanel.style.left = `${r.right - mapRect.left + 8}px`;
    }
    async function populateTracksList() {
      const list = document.getElementById('trkList');
      list.innerHTML = '';
      try {
        const res = await fetch('gpx-tracks/manifest.json');
        const files = await res.json();
        if (!Array.isArray(files) || files.length === 0) {
          list.innerHTML = `<div class="p-3 text-xs text-gray-500">Inga sp√•r funna.</div>`;
          return;
        }
        files.forEach((f) => {
          const item = document.createElement('div');
          item.className = 'trk-item';
          item.textContent = f;
          item.onclick = async () => {
            const url = `gpx-tracks/${f}`;
            const txt = await (await fetch(url)).text();
            showGpxText(txt);
            tracksPanel.classList.remove('open');
          };
          list.appendChild(item);
        });
      } catch (e) {
        list.innerHTML = `<div class="p-3 text-xs text-red-600">Kunde inte l√§sa manifest.json</div>`;
      }
    }

    // --- Trash (ta bort visat GPX) ---
    btnTrash.onclick = () => {
      map.getSource(gpxSrcId).setData({ type:'FeatureCollection', features:[] });
      gpxShown = false;
      if (drawCoords.length === 0) setDistanceKm(0);
    };

    // --- Draw ---
    btnDraw.onclick = () => {
      isDrawing = !isDrawing;
      btnDraw.classList.toggle('tool-active', isDrawing);
      if (!isDrawing) return;
      // start ‚Äì nollst√§ll nuvarande rutt
      drawCoords = [];
      updateDrawLayers();
      setDistanceKm(0);
      refreshExportState();
    };

    // --- GPS ---
    btnGPS.onclick = () => {
      followOn = !followOn;
      btnGPS.classList.toggle('tool-active', followOn);
      if (followOn) startGeolocation();
      else stopGeolocation();
    };

    function startGeolocation() {
      if (!navigator.geolocation) return alert('Geolocation saknas.');
      watchId = navigator.geolocation.watchPosition(onPosition, onPositionError, {
        enableHighAccuracy: true, timeout: 15000, maximumAge: 0
      });
      ensureOrientation(); // f√∂r ROT
    }
    function stopGeolocation() {
      if (watchId != null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
      if (!rotOn) disableOrientation();
    }
    function onPosition(pos) {
      const { latitude, longitude, accuracy } = pos.coords;
      const ll = [longitude, latitude];
      // pos
      map.getSource(posSrcId).setData({
        type:'FeatureCollection',
        features:[{ type:'Feature', geometry:{ type:'Point', coordinates: ll }, properties:{} }]
      });
      // accuracy
      const accPoly = turf.circle(ll, Math.max(accuracy, 5), { steps: 64, units: 'meters' });
      map.getSource(accSrcId).setData(accPoly);

      if (followOn || rotOn) {
        map.easeTo({ center: ll, duration: 300, zoom: Math.max(map.getZoom(), 15) });
      }
    }
    function onPositionError(err) { console.warn('Geolocation error', err); }

    // --- ROT (track-up) ---
    btnROT.onclick = () => {
      rotOn = !rotOn;
      btnROT.classList.toggle('rot-active', rotOn);
      if (rotOn) {
        ensureOrientation();
      } else {
        // √•terst√§ll bearing
        map.easeTo({ bearing: 0, duration: 300 });
        if (!followOn) disableOrientation();
      }
    };

    function ensureOrientation() {
      const needIOS = typeof DeviceOrientationEvent !== 'undefined' &&
                      typeof DeviceOrientationEvent.requestPermission === 'function';
      if (needIOS) {
        DeviceOrientationEvent.requestPermission()
          .then(state => { if (state === 'granted') startOrientation(); })
          .catch(() => {});
      } else startOrientation();
    }
    let orientationOn = false;
    function startOrientation() {
      if (orientationOn) return;
      orientationOn = true;
      window.addEventListener('deviceorientation', onOrientation, true);
      window.addEventListener('deviceorientationabsolute', onOrientation, true);
    }
    function disableOrientation() { orientationOn = false; /* l√§mnar listeners, l√•g kostnad */ }

    function onOrientation(e) {
      // Heading i grader 0..360 (0=norr). iOS: webkitCompassHeading; Android: alpha (0=norr med rotering beh√∂vd)
      let heading = null;
      const screenAngle = (screen.orientation && typeof screen.orientation.angle === 'number') ? screen.orientation.angle : 0;

      if (typeof e.webkitCompassHeading === 'number') {
        heading = e.webkitCompassHeading; // iOS: redan 0=norr, medurs
      } else if (typeof e.alpha === 'number') {
        let h = 360 - e.alpha;  // g√∂r 0=norr, medurs
        h = h - screenAngle;    // kompensera sk√§rmens rotation
        heading = (h % 360 + 360) % 360;
      }

      if (heading == null) return;
      currentHeading = heading;

      if (rotOn) {
        // ‚Äútrack-up‚Äù: kartan roteras motsols s√• att ‚Äúupp‚Äù = heading
        map.setBearing(-currentHeading);
      }
    }

    // --- Visa GPX ---
    function showGpxText(gpxText) {
      try {
        const parser = new DOMParser();
        const xml = parser.parseFromString(gpxText, 'application/xml');
        const gj = toGeoJSON.gpx(xml); // -> GeoJSON
        // extrahera linjer (LineString/ MultiLineString)
        const lineFeatures = [];
        (gj.features || []).forEach(f => {
          if (!f.geometry) return;
          const t = f.geometry.type;
          if (t === 'LineString') lineFeatures.push(f);
          if (t === 'MultiLineString') {
            f.geometry.coordinates.forEach(coords => {
              lineFeatures.push({ type:'Feature', properties:f.properties||{}, geometry:{ type:'LineString', coordinates: coords } });
            });
          }
        });
        const fc = { type:'FeatureCollection', features: lineFeatures };
        map.getSource(gpxSrcId).setData(fc);
        gpxShown = lineFeatures.length > 0;

        if (gpxShown) {
          // fit bounds
          const bbox = turf.bbox(fc);
          map.fitBounds([[bbox[0], bbox[1]], [bbox[2], bbox[3]]], { padding: 40, maxZoom: MAX_ZOOM });
          // uppdatera distans (summa)
          let total = 0;
          lineFeatures.forEach(f => { total += turf.length(f, { units:'kilometers' }); });
          setDistanceKm(total);
        } else {
          if (drawCoords.length === 0) setDistanceKm(0);
        }
      } catch (err) {
        console.error('Kunde inte tolka GPX:', err);
      }
    }

    // --- Enkel lagerbytare via konsol (om du vill g√∂ra knappar, s√§g till) ---
    // Exempel: setBase('esri'); // f√∂r att byta till satellit

    // Init
    setDistanceKm(0);
  })();
  </script>
</body>
</html>
