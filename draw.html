<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mjukt Ritverktyg - Contortions in the clay</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IM+Fell+DW+Pica&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #F6F6EF; 
            touch-action: none;
            font-family: 'IM Fell DW Pica', serif;
        }
        canvas {
            display: block;
            cursor: crosshair;
        }
        .controls {
            position: fixed;
            bottom: 20px;
            left: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: transparent;
            padding: 5px;
            z-index: 100;
        }
        input[type="range"] {
            accent-color: #000000;
            width: 80px;
        }
        .btn {
            color: #666;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: color 0.2s;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            font-family: 'Inter', sans-serif;
        }
        .btn:hover {
            color: black;
        }
        .size-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: black;
        }
    </style>
</head>
<body>

    <div class="controls">
        <div class="flex items-center gap-2">
            <div class="size-indicator"></div>
            <input type="range" id="sizePicker" min="20" max="200" value="80">
        </div>
        <button id="clearBtn" class="btn">RENSA</button>
        <button id="saveBtn" class="btn text-black">SPARA</button>
    </div>

    <canvas id="paintCanvas"></canvas>

    <script>
        const canvas = document.getElementById('paintCanvas');
        const ctx = canvas.getContext('2d');
        const sizePicker = document.getElementById('sizePicker');
        const clearBtn = document.getElementById('clearBtn');

        let isDrawing = false;
        let points = [];
        
        let mouse = { x: 0, y: 0 };
        let brush = { x: 0, y: 0 };
        const damping = 0.12; 

        // Laddar typsnitt och initierar
        window.onload = () => {
            document.fonts.load("48px 'IM Fell DW Pica'").then(() => {
                initCanvas();
            });
        };

        function initCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            resetCanvas();
        }

        function resetCanvas() {
            ctx.fillStyle = "#F6F6EF";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = "black";
            
            // Övre text: Vänsterställd (24px marginal)
            // Storlek 48px, Line-height 56px, radbrytning efter "in"
            ctx.textAlign = "left";
            ctx.font = "48px 'IM Fell DW Pica'";
            const lineHeight = 56;
            const x = 24;
            const yStart = 24 + 48;
            
            ctx.fillText("Contortions in", x, yStart);
            ctx.fillText("the clay", x, yStart + lineHeight);

            // Nedre text: Högerställd (24px marginal)
            ctx.textAlign = "right";
            ctx.font = "18px 'IM Fell DW Pica'";
            ctx.fillText("Fig. x.", canvas.width - 24, canvas.height - 24);
        }

        function resizeCanvas() {
            const tempData = canvas.toDataURL();
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const img = new Image();
            img.onload = () => {
                ctx.fillStyle = "#F6F6EF";
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = tempData;
        }

        window.addEventListener('resize', resizeCanvas);

        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            const clientX = e.touches ? e.touches[0].clientX : e.clientX;
            const clientY = e.touches ? e.touches[0].clientY : e.clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }

        function startDrawing(e) {
            isDrawing = true;
            const pos = getPos(e);
            mouse.x = pos.x;
            mouse.y = pos.y;
            brush.x = pos.x;
            brush.y = pos.y;
            points = [];
            points.push({ x: pos.x, y: pos.y });
            drawLoop();
        }

        function drawLoop() {
            if (!isDrawing) return;

            brush.x += (mouse.x - brush.x) * damping;
            brush.y += (mouse.y - brush.y) * damping;

            const lastPoint = points[points.length - 1];
            const dist = Math.hypot(brush.x - lastPoint.x, brush.y - lastPoint.y);

            if (dist > 1.5) {
                if (points.length === 1) {
                    const dx = brush.x - points[0].x;
                    const dy = brush.y - points[0].y;
                    drawTerminator(points[0].x, points[0].y, Math.atan2(dy, dx));
                }
                
                points.push({ x: brush.x, y: brush.y });
                renderDynamicStroke();
            }

            requestAnimationFrame(drawLoop);
        }

        function drawTerminator(x, y, angle) {
            const baseSize = parseInt(sizePicker.value);
            const nx = Math.cos(angle + Math.PI / 2);
            const ny = Math.sin(angle + Math.PI / 2);
            
            const lineCount = 7;
            const spacing = baseSize / 10;
            const lineWidth = baseSize / 40;
            
            const totalWidth = ((lineCount - 1) * spacing) + lineWidth;
            const halfWidth = totalWidth / 2;

            ctx.beginPath();
            ctx.strokeStyle = "black";
            ctx.lineWidth = Math.max(1, baseSize / 25);
            ctx.lineCap = 'butt';
            ctx.moveTo(x - nx * halfWidth, y - ny * halfWidth);
            ctx.lineTo(x + nx * halfWidth, y + ny * halfWidth);
            ctx.stroke();
        }

        function renderDynamicStroke() {
            if (points.length < 3) return;

            const p1 = points[points.length - 3];
            const p2 = points[points.length - 2];
            const p3 = points[points.length - 1];

            const dx = p3.x - p1.x;
            const dy = p3.y - p1.y;
            const angle = Math.atan2(dy, dx);
            
            const nx = Math.cos(angle + Math.PI / 2);
            const ny = Math.sin(angle + Math.PI / 2);

            const mid1 = { x: (p1.x + p2.x) / 2, y: (p1.y + p2.y) / 2 };
            const mid2 = { x: (p2.x + p3.x) / 2, y: (p2.y + p3.y) / 2 };

            const baseSize = parseInt(sizePicker.value);
            const lineCount = 7;
            const spacing = baseSize / 10; 
            
            ctx.lineCap = 'butt';
            ctx.strokeStyle = "black";
            ctx.lineWidth = baseSize / 40; 

            for (let i = 0; i < lineCount; i++) {
                const offsetAmount = (i - (lineCount / 2)) * spacing;
                const offX = nx * offsetAmount;
                const offY = ny * offsetAmount;
                
                ctx.beginPath();
                ctx.moveTo(mid1.x + offX, mid1.y + offY);
                ctx.quadraticCurveTo(p2.x + offX, p2.y + offY, mid2.x + offX, mid2.y + offY);
                ctx.stroke();
            }
        }

        function stopDrawing() {
            if (isDrawing && points.length > 2) {
                const pEnd = points[points.length - 1];
                const pPrev = points[points.length - 2];
                const dx = pEnd.x - pPrev.x;
                const dy = pEnd.y - pPrev.y;
                drawTerminator(pEnd.x, pEnd.y, Math.atan2(dy, dx));
            }
            isDrawing = false;
        }

        canvas.addEventListener('mousedown', startDrawing);
        window.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            const pos = getPos(e);
            mouse.x = pos.x;
            mouse.y = pos.y;
        });
        window.addEventListener('mouseup', stopDrawing);

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startDrawing(e);
        }, { passive: false });

        canvas.addEventListener('touchmove', (e) => {
            e.preventDefault();
            const pos = getPos(e);
            mouse.x = pos.x;
            mouse.y = pos.y;
        }, { passive: false });

        canvas.addEventListener('touchend', stopDrawing);

        clearBtn.addEventListener('click', () => {
            resetCanvas();
        });

        document.getElementById('saveBtn').addEventListener('click', () => {
            const link = document.createElement('a');
            link.download = 'contortions-clay.png';
            link.href = canvas.toDataURL();
            link.click();
        });
    </script>
</body>
</html>
