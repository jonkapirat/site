<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SVG Quiz</title>
    <!-- Inkludera Tailwind CSS för enkel styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Animation för rätt/fel svar */
        @keyframes flashCorrect {
            0% { background-color: transparent; }
            50% { background-color: #4CAF50; /* Grön färg */ }
            100% { background-color: transparent; }
        }

        @keyframes flashIncorrect {
            0% { background-color: transparent; }
            50% { background-color: #F44336; /* Röd färg */ }
            100% { background-color: transparent; }
        }

        .flash-correct {
            animation: flashCorrect 0.6s ease-out; /* Blixtrar grönt */
        }

        .flash-incorrect {
            animation: flashIncorrect 0.6s ease-out; /* Blixtrar rött */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center bg-gray-100">

    <!-- Startskärm -->
    <div id="startScreenContainer" class="bg-white rounded-2xl w-[340px] h-[540px] p-12 flex flex-col items-center justify-center">
        <h2 class="text-4xl font-bold text-gray-800 mb-2">Quiz</h2>
        <h3 class="text-xl font-semibold text-gray-600 mb-8">Kontrolldefinitioner</h3>
        <button id="startButton" class="px-6 py-3 bg-black text-white font-semibold rounded-md shadow-none hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2 transition duration-150 ease-in-out">
            Starta
        </button>
    </div>

    <!-- Den faktiska synliga kortbehållaren för frågor -->
    <div id="mainCardContainer" class="bg-white rounded-2xl w-[340px] h-[540px] p-12 flex flex-col items-center justify-center hidden">

        <!-- Kortets framsida (fråga) -->
        <div id="cardFront" class="w-full flex flex-col items-center justify-center flex-grow">
            <!-- SVG-behållare -->
            <div class="w-36 h-36 border-2 border-black flex items-center justify-center mb-8 overflow-hidden">
                <!-- SVG-koden kommer att infogas här dynamiskt -->
                <!-- questionSvgContainer har nu p-5 för att skapa 20px "padding" (innerutrymme) -->
                <div id="questionSvgContainer" class="w-full h-full flex items-center justify-center p-5"></div>
            </div>

            <!-- Behållare för de utlinjerade knapparna -->
            <div id="answerButtons" class="w-full flex flex-col items-center space-y-3">
                <!-- Knappar kommer att genereras här med JavaScript -->
            </div>
        </div>

        <!-- Baksidan av kortet (ej i bruk) -->
        <div id="cardBack" class="w-full flex flex-col items-center justify-center flex-grow hidden">
        </div>
    </div>

    <!-- Behållare för frågenummer och tidsräknare -->
    <div id="questionInfoContainer" class="flex justify-between w-[340px] px-12 mt-4 hidden">
        <span id="questionNumber" class="text-sm font-normal text-gray-700">1/10</span>
        <span id="timer" class="text-sm font-normal text-gray-700">0:00</span>
    </div>

    <!-- Behållare för resultatvisning (utanför kortet) -->
    <div id="resultDisplayContainer" class="rounded-2xl w-[340px] h-[540px] p-12 flex flex-col items-center justify-center hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Resultat</h2>
        <p id="resultText" class="text-xl font-semibold text-gray-700 mb-8 text-center"></p>
        <button id="restartButton" class="px-6 py-3 bg-black text-white font-semibold rounded-md shadow-none hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2 transition duration-150 ease-in-out">
            Starta om
        </button>
    </div>

    <script>
        const startScreenContainer = document.getElementById('startScreenContainer');
        const mainCardContainer = document.getElementById('mainCardContainer');
        const cardFront = document.getElementById('cardFront');
        const questionSvgContainer = document.getElementById('questionSvgContainer');
        const answerButtonsContainer = document.getElementById('answerButtons');
        const questionNumberSpan = document.getElementById('questionNumber');
        const timerSpan = document.getElementById('timer');
        const resultText = document.getElementById('resultText');
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton');
        const questionInfoContainer = document.getElementById('questionInfoContainer');
        const resultDisplayContainer = document.getElementById('resultDisplayContainer');

        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let secondsElapsed = 0;
        let questions = []; // Kommer att innehålla quizfrågorna som genereras från allQuestionData
        const quizLength = 10; // Antal frågor per quiz

        // Ändrat till relativa sökvägar eftersom index.html ligger i samma mapp
        const BASE_IMAGE_URL = ''; // Tom sträng för att referera till den aktuella mappen
        const JSON_DATA_URL = 'quiz-data.json'; // Direkt filnamn i samma mapp

        let allQuestionData = []; // Denna kommer att fyllas från JSON-filen dynamiskt

        // Funktion för att blanda array-element
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Initierar visning av startskärmen
        function init() {
            startScreenContainer.classList.remove('hidden');
            mainCardContainer.classList.add('hidden');
            questionInfoContainer.classList.add('hidden');
            resultDisplayContainer.classList.add('hidden');
        }

        // Startar quiz-logiken
        async function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            secondsElapsed = 0; // Återställ totala tiden för quizet vid start
            
            try {
                // Ladda quizdatan från JSON-filen
                const response = await fetch(JSON_DATA_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                allQuestionData = await response.json();
            } catch (error) {
                console.error("Kunde inte ladda quiz-data:", error);
                resultText.textContent = "Kunde inte ladda frågorna. Vänligen försök igen senare.";
                mainCardContainer.classList.add('hidden');
                resultDisplayContainer.classList.remove('hidden');
                questionInfoContainer.classList.add('hidden');
                return; // Avbryt quizstart om data inte kunde laddas
            }

            // Väljer ett slumpmässigt urval av frågor från allQuestionData
            const shuffledAllQuestions = [...allQuestionData];
            shuffleArray(shuffledAllQuestions);
            // Se till att vi inte försöker ta fler frågor än vad som finns
            questions = shuffledAllQuestions.slice(0, Math.min(quizLength, allQuestionData.length)); 

            if (questions.length === 0) {
                 resultText.textContent = "Inga frågor att visa. Vänligen kontrollera quiz-datan.";
                 mainCardContainer.classList.add('hidden');
                 resultDisplayContainer.classList.remove('hidden');
                 questionInfoContainer.classList.add('hidden');
                 return;
            }

            startScreenContainer.classList.add('hidden');
            mainCardContainer.classList.remove('hidden');
            questionInfoContainer.classList.remove('hidden');
            resultDisplayContainer.classList.add('hidden');

            // Initialisera timern och visa den direkt
            timerSpan.textContent = '0:00';
            startTimer(); // Starta timern här när quizet börjar

            displayQuestion();
        }

        // Visar en specifik fråga
        async function displayQuestion() {
            if (currentQuestionIndex < questions.length) {
                const question = questions[currentQuestionIndex];

                try {
                    // Ladda SVG-koden för den aktuella frågan
                    // Eftersom BASE_IMAGE_URL nu är tom, blir sökvägen direkt filnamnet.
                    const svgResponse = await fetch(BASE_IMAGE_URL + question.filename);
                    if (!svgResponse.ok) {
                        throw new Error(`Kunde inte ladda SVG-bild: ${question.filename}, status: ${svgResponse.status}`);
                    }
                    let svgText = await svgResponse.text();

                    // Ta bort width, height, och stroke-width attributen från SVG-strängen.
                    // Ersätt sedan alla fill och stroke attribut med fill/stroke="currentColor" OM de INTE är "none".
                    svgText = svgText
                        .replace(/<svg([^>]*)width=['"].*?['"]([^>]*)>/g, '<svg$1$2>')
                        .replace(/<svg([^>]*)height=['"].*?['"]([^>]*)>/g, '<svg$1$2>')
                        .replace(/stroke-width=['"].*?['"]/g, ''); // Ta bort stroke-width från alla element

                    // Använd DOMParser för att manipulera SVG:n mer säkert
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                    const svgElement = svgDoc.documentElement;

                    // Sätt currentColor som standard för fyllning och linjer på element som inte är fill/stroke="none"
                    const elementsToColor = svgElement.querySelectorAll('*'); // Välj alla element för generell färgning

                    elementsToColor.forEach(el => {
                        const fill = el.getAttribute('fill');
                        const stroke = el.getAttribute('stroke');

                        if (fill !== null && fill.toLowerCase() !== 'none') {
                            el.setAttribute('fill', 'currentColor');
                        }
                        if (stroke !== null && stroke.toLowerCase() !== 'none') {
                            el.setAttribute('stroke', 'currentColor');
                        }
                    });

                    // Serialisera tillbaka till en sträng
                    const cleanedSvgCode = new XMLSerializer().serializeToString(svgElement);

                    questionSvgContainer.innerHTML = cleanedSvgCode;
                    questionSvgContainer.style.color = '#231F20'; // Tvinga färgen till #231F20 via currentColor

                } catch (error) {
                    console.error(`Fel vid laddning eller visning av SVG för ${question.filename}:`, error);
                    questionSvgContainer.innerHTML = `<p class="text-red-500">Kunde inte ladda bild för denna fråga.</p>`;
                }

                // Uppdatera frågenummer
                questionNumberSpan.textContent = `${currentQuestionIndex + 1}/${questions.length}`;

                // Rensa befintliga knappar
                answerButtonsContainer.innerHTML = '';

                // Skapa svarsalternativ
                let answerOptions = [];
                // Lägg till det korrekta svaret
                answerOptions.push({ text: question.answer, isCorrect: true });

                // Hämta inkorrekta svar från övriga frågor (från hela poolen av frågor)
                const incorrectAnswersPool = allQuestionData
                    .filter(q => q.answer !== question.answer) // Exkludera den aktuella frågans korrekta svar
                    .map(q => q.answer); // Hämta bara svarstexterna

                shuffleArray(incorrectAnswersPool); // Blanda poolen av inkorrekta svar

                // Lägg till 3 unika inkorrekta svar, om tillgängliga
                let addedIncorrectAnswers = 0;
                for (let i = 0; i < incorrectAnswersPool.length && addedIncorrectAnswers < 3; i++) {
                    // Kontrollera att det inkorrekta svaret inte redan finns bland de valda alternativen
                    if (!answerOptions.some(opt => opt.text === incorrectAnswersPool[i])) {
                        answerOptions.push({ text: incorrectAnswersPool[i], isCorrect: false });
                        addedIncorrectAnswers++;
                    }
                }
                
                // Om det finns färre än 3 unika felaktiga svar (t.ex. om allQuestionData är liten), fyll på med generiska
                while (answerOptions.length < 4) { // Se till att vi alltid har 4 alternativ
                    const genericFiller = `Falskt Svar ${answerOptions.length + 1}`;
                    if (!answerOptions.some(opt => opt.text === genericFiller)) {
                        answerOptions.push({ text: genericFiller, isCorrect: false });
                    } else {
                        // Fallback om den generiska redan finns, lägg till slumpmässig sträng
                        answerOptions.push({ text: `Annat falskt svar ${Math.random().toFixed(4)}`, isCorrect: false });
                    }
                }


                shuffleArray(answerOptions); // Blanda alla svarsalternativ

                // Skapa knappar för alla svarsalternativ
                answerOptions.forEach(answer => {
                    const button = document.createElement('button');
                    button.classList.add('w-full', 'px-4', 'py-2', 'border', 'border-gray-400', 'bg-transparent', 'text-gray-700', 'font-semibold', 'rounded-md', 'hover:bg-gray-200', 'hover:text-black', 'focus:outline-none', 'focus:ring-2', 'focus:ring-gray-400', 'focus:ring-offset-2', 'transition', 'duration-150', 'ease-in-out');
                    button.textContent = answer.text;
                    button.dataset.isCorrect = answer.isCorrect;

                    button.addEventListener('click', () => handleAnswerClick(button, answer.isCorrect));
                    answerButtonsContainer.appendChild(button);
                });

            } else {
                showResults();
            }
        }

        // Hanterar klick på en svarsknapp
        function handleAnswerClick(clickedButton, isCorrect) {
            // Timern stoppas först vid showResults()

            // Inaktivera alla knappar för att förhindra flera klick
            Array.from(answerButtonsContainer.children).forEach(button => {
                button.disabled = true;
            });

            // Visa feedback (rött/grönt blixt)
            if (isCorrect) {
                score++;
                clickedButton.classList.add('flash-correct');
            } else {
                clickedButton.classList.add('flash-incorrect');
            }

            // Vänta lite efter blixten, sedan byt fråga eller visa resultat
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    displayQuestion();
                } else {
                    showResults(); // Visa resultat om alla frågor är besvarade
                }
            }, 1000); // Kort paus efter blixten
        }

        // Startar timern (körs en gång när quizet börjar)
        function startTimer() {
            if (!timerInterval) { // Se till att timern bara startar en gång
                timerInterval = setInterval(() => {
                    secondsElapsed++;
                    const minutes = Math.floor(secondsElapsed / 60);
                    const seconds = secondsElapsed % 60;
                    timerSpan.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }, 1000);
            }
        }

        // Stoppar timern
        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null; // Återställ så att den kan startas igen
        }

        // Visar resultatskärmen
        function showResults() {
            stopTimer(); // Stoppa timern när quizet är slut

            const totalMinutes = Math.floor(secondsElapsed / 60);
            const totalSeconds = secondsElapsed % 60;
            const formattedTime = `${totalMinutes}:${totalSeconds < 10 ? '0' : ''}${totalSeconds}`;

            resultText.innerHTML = `
                <p>Total tid: ${formattedTime}</p>
                <p>${score} rätt av ${questions.length}</p>
            `;

            mainCardContainer.classList.add('hidden');
            resultDisplayContainer.classList.remove('hidden');
            questionInfoContainer.classList.add('hidden');
        }

        // Eventlyssnare för "Starta"-knappen på startskärmen
        startButton.addEventListener('click', startQuiz);

        // Eventlyssnare för "Starta om"-knappen på resultatskärmen
        restartButton.addEventListener('click', init);

        // Initiera startskärmen när sidan laddas
        document.addEventListener('DOMContentLoaded', () => {
            init();
        });
    </script>
</body>
</html>
