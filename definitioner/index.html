<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Träna på Kontrolldefinitioner</title>
    <!-- Inkludera Tailwind CSS för enkel styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F3F4F6; /* Standard ljus bakgrund för body */
        }

        /* Animation för rätt/fel svar */
        @keyframes flashCorrect {
            0% { background-color: transparent; }
            50% { background-color: #4CAF50; /* Grön färg */ }
            100% { background-color: transparent; }
        }

        @keyframes flashIncorrect {
            0% { background-color: transparent; }
            50% { background-color: #F44336; /* Röd färg */ }
            100% { background-color: transparent; }
        }

        .flash-correct {
            animation: flashCorrect 0.4s ease-out; /* Blixtrar grönt */
        }

        .flash-incorrect {
            animation: flashIncorrect 0.4s ease-out; /* Blixtrar rött */
        }

        /* Anpassad styling för checkbox och radiobuttons när de är valda (svarta) */
        input[type="checkbox"]:checked,
        input[type="radio"]:checked {
            accent-color: #000; /* Gör dem svarta när de är ikryssade/valda */
        }

        /* Dark mode styles */
        html.dark body { /* Ändrad selector för att specifikt påverka body i dark mode */
            background-color: #212121; /* Mörk bakgrund för body, uppdaterad färg */
            color: #e0e0e0; /* Ljus textfärg för body */
        }

        html.dark #startScreenContainer,
        html.dark #mainCardContainer,
        html.dark #resultDisplayContainer {
            background-color: #333; /* Mörkare kortbakgrund */
            color: #e0e0e0; /* Ljus textfärg för kort */
        }

        html.dark #startScreenContainer h2,
        html.dark #startScreenContainer h3 {
            color: #f0f0f0; /* Säkerställ att rubriker är synliga */
        }

        html.dark label,
        html.dark span {
            color: #c0c0c0; /* Säkerställ att etiketter och span är synliga */
        }

        html.dark button {
            background-color: #212121; /* Uppdaterad färg för svarsknappar */
            color: #e0e0e0;
            border-color: #414141; /* Uppdaterad färg för svarsknapparnas ram */
        }

        html.dark button:hover {
            background-color: #777;
            color: #ffffff;
        }

        /* Specifik för bildbehållaren för att förbli ljus */
        html.dark #questionSvgContainer {
            background-color: #ffffff; /* Explicit vit bakgrund */
            border-color: #000000; /* Behåll svart kantlinje */
            color: #231F20; /* Behåll SVG-element mörka mot vit bakgrund */
        }

        /* Dark mode toggle icon och close button styling i dark mode */
        html.dark #darkModeToggle,
        html.dark #closeQuizButton {
            border-color: #777; /* Lättare kantlinje i mörkt läge */
            color: #c0c0c0; /* Ljusare ikonfärg för mörk bakgrund */
        }

        html.dark #darkModeToggle:hover,
        html.dark #closeQuizButton:hover {
            background-color: #444; /* Mörkare bakgrund vid hovring */
            color: #ffffff; /* Vit ikon vid hovring */
        }

        /* Styling for disabled button */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        html.dark button:disabled {
            background-color: #212121; /* Same as normal button in dark mode */
            border-color: #414141; /* Same as normal button in dark mode */
            color: #c0c0c0; /* Slightly lighter to indicate disabled */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center">

    <!-- Dark Mode Toggle Icon -->
    <div id="darkModeToggle" class="fixed top-4 right-4 cursor-pointer p-1 w-8 h-8 rounded-full border-2 border-gray-400 text-gray-700 hover:bg-gray-200 hover:text-black transition duration-150 ease-in-out flex items-center justify-center z-50">
        <!-- Moon Icon (default/light mode) -->
        <svg id="moonIcon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
        <!-- Sun Icon (hidden by default/dark mode) -->
        <svg id="sunIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
    </div>

    <!-- Startskärm -->
    <div id="startScreenContainer" class="bg-white rounded-2xl w-full mx-2 sm:max-w-[340px] sm:mx-auto h-[540px] p-12 flex flex-col items-center justify-center">
        <!-- Behållare för Orion-loggan -->
        <div id="orionLogoContainer" class="w-16 h-16 mb-4 flex items-center justify-center">
            <!-- SVG för Orion-loggan kommer att laddas här dynamiskt -->
        </div>
        <h2 class="text-4xl font-bold text-gray-800 mb-2">Träna</h2>
        <h3 class="text-xl font-semibold text-gray-600 mb-8">Kontrolldefinitioner</h3>

        <!-- Nya kryssrutor för att inkludera olika typer av frågor -->
        <div class="mb-6 flex flex-col items-start w-full">
            <div class="flex items-center mb-2">
                <input type="checkbox" id="includeControlItems" checked class="h-4 w-4 text-black focus:ring-black rounded">
                <label for="includeControlItems" class="ml-2 text-gray-700 font-semibold">Kontrollföremål</label>
            </div>
            <div class="flex items-center">
                <input type="checkbox" id="includeExtraPlacement" class="h-4 w-4 text-black focus:ring-black rounded">
                <label for="includeExtraPlacement" class="ml-2 text-gray-700 font-semibold">Placeringar, utseende mm.</label>
            </div>
        </div>

        <!-- Ny radioknappsgrupp för antal frågor -->
        <div class="mb-8 text-center">
            <label class="block text-gray-700 font-semibold mb-2">Antal frågor</label>
            <div class="flex justify-center space-x-4">
                <div class="flex items-center">
                    <input type="radio" id="numQuestions10" name="quizCount" value="10" checked class="h-4 w-4 text-black focus:ring-black">
                    <label for="numQuestions10" class="ml-1 text-gray-700">10</label>
                </div>
                <div class="flex items-center">
                    <input type="radio" id="numQuestions30" name="quizCount" value="30" class="h-4 w-4 text-black focus:ring-black">
                    <label for="numQuestions30" class="ml-1 text-gray-700">30</label>
                </div>
                <div class="flex items-center">
                    <input type="radio" id="numQuestionsAll" name="quizCount" value="all" class="h-4 w-4 text-black focus:ring-black">
                    <label for="numQuestionsAll" class="ml-1 text-gray-700">Alla</label>
                </div>
            </div>
        </div>

        <button id="startButton" class="px-6 py-3 bg-black text-white font-semibold rounded-md shadow-none hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2 transition duration-150 ease-in-out">
            Starta quiz
        </button>
    </div>

    <!-- Den faktiska synliga kortbehållaren för frågor -->
    <div id="mainCardContainer" class="bg-white rounded-2xl w-full mx-2 sm:max-w-[340px] sm:mx-auto h-[540px] p-12 flex flex-col items-center justify-center hidden">

        <!-- Kortets framsida (fråga) -->
        <div id="cardFront" class="w-full flex flex-col items-center justify-center flex-grow">
            <!-- SVG-behållare -->
            <div class="w-36 h-36 border-2 border-black flex items-center justify-center mb-8 overflow-hidden">
                <!-- SVG-koden kommer att infogas här dynamiskt -->
                <!-- questionSvgContainer har nu p-5 för att skapa 20px "padding" (innerutrymme) -->
                <div id="questionSvgContainer" class="w-full h-full flex items-center justify-center p-5"></div>
            </div>

            <!-- Behållare för de utlinjerade knapparna -->
            <div id="answerButtons" class="w-full flex flex-col items-center space-y-3">
                <!-- Knappar kommer att genereras här med JavaScript -->
            </div>
        </div>

        <!-- Baksidan av kortet (ej i bruk) -->
        <div id="cardBack" class="w-full flex flex-col items-center justify-center flex-grow hidden">
        </div>
    </div>

    <!-- Behållare för frågenummer, stängknapp och tidsräknare -->
    <div id="questionInfoContainer" class="flex justify-between items-center w-full px-4 sm:w-[340px] sm:px-12 sm:mx-auto mt-4 hidden">
        <span id="questionNumber" class="text-sm font-normal text-gray-700">1/10</span>
        <!-- Stäng-knappen, dold initialt -->
        <div id="closeQuizButton" class="hidden cursor-pointer p-1 w-8 h-8 rounded-full border-2 border-gray-400 text-gray-700 hover:bg-gray-200 hover:text-black transition duration-150 ease-in-out flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x">
                <line x1="18" y1="6" x2="6" y2="18"></line>
                <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
        </div>
        <span id="timer" class="text-sm font-normal text-gray-700">0:00</span>
    </div>


    <!-- Behållare för resultatvisning (utanför kortet) -->
    <div id="resultDisplayContainer" class="rounded-2xl w-full mx-2 sm:max-w-[340px] sm:mx-auto h-[540px] p-12 flex flex-col items-center justify-center hidden">
        <h2 class="text-2xl font-bold text-gray-800 mb-4">Resultat</h2>
        <p id="resultText" class="text-xl font-semibold text-gray-700 mb-8 text-center"></p>
        <button id="restartButton" class="px-6 py-3 bg-black text-white font-semibold rounded-md shadow-none hover:bg-gray-800 focus:outline-none focus:ring-2 focus:ring-black focus:ring-offset-2 transition duration-150 ease-in-out">
            Starta om
        </button>
    </div>

    <script>
        // Filnamn för Orion-loggan
        const ORION_LOGO_FILENAME = 'Orion-logo-skold.svg';
        // Ny bas-URL för Orion-loggan, som ligger i rotmappen för definitioner
        const ORION_LOGO_BASE_URL = '';

        const startScreenContainer = document.getElementById('startScreenContainer');
        const mainCardContainer = document.getElementById('mainCardContainer');
        const cardFront = document.getElementById('cardFront');
        const questionSvgContainer = document.getElementById('questionSvgContainer');
        const answerButtonsContainer = document.getElementById('answerButtons');
        const questionNumberSpan = document.getElementById('questionNumber');
        const timerSpan = document.getElementById('timer');
        const resultText = document.getElementById('resultText');
        const startButton = document.getElementById('startButton');
        const restartButton = document.getElementById('restartButton');
        const questionInfoContainer = document.getElementById('questionInfoContainer');
        const resultDisplayContainer = document.getElementById('resultDisplayContainer');
        const closeQuizButton = document.getElementById('closeQuizButton');
        const orionLogoContainer = document.getElementById('orionLogoContainer');

        // Dark mode toggle elements
        const darkModeToggle = document.getElementById('darkModeToggle');
        const moonIcon = document.getElementById('moonIcon');
        const sunIcon = document.getElementById('sunIcon');

        // Elementreferenser för inställningar
        const includeControlItemsCheckbox = document.getElementById('includeControlItems');
        const includeExtraPlacementCheckbox = document.getElementById('includeExtraPlacement');
        const numQuestionsRadioButtons = document.querySelectorAll('input[name="quizCount"]');
        
        let currentQuestionIndex = 0;
        let score = 0;
        let timerInterval;
        let secondsElapsed = 0;
        let questions = []; // Kommer att innehålla de utvalda quizfrågorna
        let quizLength = 10; // Standardantal frågor

        // Uppdaterad bas-URL för huvudbilder
        const BASE_IMAGE_URL = './foremal/'; // Uppdaterad till nya foldern
        const BASE_IMAGE_URL_EXTRA = './extra/'; // Bas-URL för extra bilder

        const MAIN_JSON_DATA_URL = './quiz-data.json';
        const EXTRA_JSON_DATA_URL = './extra-quiz-data.json'; 
        
        let allMainQuestionData = []; // Denna kommer att fyllas med frågor från huvud-JSON
        let allExtraQuestionData = []; // Denna kommer att fyllas med frågor från extra-JSON

        // Funktion för att blanda array-element
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // Funktion för att ladda och visa Orion-loggan
        async function loadOrionLogo() {
            try {
                // Använd den nya specifika bas-URL:en för loggan
                const svgResponse = await fetch(ORION_LOGO_FILENAME);
                if (!svgResponse.ok) {
                    throw new Error(`Kunde inte ladda Orion-logga: ${ORION_LOGO_FILENAME}, status: ${svgResponse.status}`);
                }
                let svgText = await svgResponse.text();

                // Ta bort width, height, och stroke-width attributen från SVG-strängen.
                // Behåll alla fill/stroke attribut som de är i original-SVG:n för loggan.
                svgText = svgText
                    .replace(/<svg([^>]*)width=['"].*?['"]([^>]*)>/g, '<svg$1$2>')
                    .replace(/<svg([^>]*)height=['"].*?['"]([^>]*)>/g, '<svg$1$2>')
                    .replace(/stroke-width=['"].*?['"]/g, '');

                orionLogoContainer.innerHTML = svgText; // Infoga den rensade men ofärgade SVG:n

            } catch (error) {
                console.error(`Fel vid laddning eller visning av Orion-loggan:`, error);
                orionLogoContainer.innerHTML = `<p class="text-red-500 text-xs">Kunde ej ladda logga.</p>`;
            }
        }

        // Funktion för att sätta temat (ljus/mörk)
        function setTheme(isDark) {
            if (isDark) {
                document.documentElement.classList.add('dark');
                moonIcon.classList.add('hidden');
                sunIcon.classList.remove('hidden');
            } else {
                document.documentElement.classList.remove('dark');
                moonIcon.classList.remove('hidden');
                sunIcon.classList.add('hidden');
            }
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // Funktion för att kontrollera och uppdatera knappen disabled-state
        function updateStartButtonState() {
            if (!includeControlItemsCheckbox.checked && !includeExtraPlacementCheckbox.checked) {
                startButton.disabled = true;
            } else {
                startButton.disabled = false;
            }
        }

        // Initierar visning av startskärmen
        function init() {
            startScreenContainer.classList.remove('hidden');
            mainCardContainer.classList.add('hidden');
            questionInfoContainer.classList.add('hidden');
            resultDisplayContainer.classList.add('hidden');
            closeQuizButton.classList.add('hidden'); // Dölj stäng-knappen
        }

        // Startar quiz-logiken
        async function startQuiz() {
            currentQuestionIndex = 0;
            score = 0;
            secondsElapsed = 0; // Återställ totala tiden för quizet vid start
            
            let combinedQuestions = [];

            const includeControl = includeControlItemsCheckbox.checked;
            const includeExtra = includeExtraPlacementCheckbox.checked;

            if (!includeControl && !includeExtra) {
                // Detta bör inte hända om knappen är disabled, men som en extra säkerhetskontroll
                alert("Vänligen välj minst en typ av frågor för quizen (Kontrollföremål eller Extra placering mm.).");
                return; // Avbryt quizstart om ingen typ är vald
            }

            try {
                if (includeControl) {
                    const mainResponse = await fetch(MAIN_JSON_DATA_URL);
                    if (!mainResponse.ok) {
                        throw new Error(`HTTP error! status (main quiz data): ${mainResponse.status}`);
                    }
                    allMainQuestionData = await mainResponse.json();
                    // Lägg till basePath till varje fråga
                    combinedQuestions = combinedQuestions.concat(
                        allMainQuestionData.map(q => ({ ...q, basePath: BASE_IMAGE_URL }))
                    );
                }
                
                if (includeExtra) {
                    const extraResponse = await fetch(EXTRA_JSON_DATA_URL);
                    if (!extraResponse.ok) {
                        // Om extra JSON inte kan laddas, logga varning men fortsätt med vad som laddats
                        console.warn(`Kunde inte ladda extra quiz-data (${EXTRA_JSON_DATA_URL}), status: ${extraResponse.status}. Fortsätter med tillgängliga frågor.`);
                    } else {
                        allExtraQuestionData = await extraResponse.json();
                        // Lägg till basePath till varje extra fråga
                        combinedQuestions = combinedQuestions.concat(
                            allExtraQuestionData.map(q => ({ ...q, basePath: BASE_IMAGE_URL_EXTRA }))
                        );
                    }
                }
            } catch (error) {
                console.error("Kunde inte ladda quiz-data:", error);
                resultText.textContent = "Kunde inte ladda frågorna. Vänligen försök igen senare.";
                mainCardContainer.classList.add('hidden');
                resultDisplayContainer.classList.remove('hidden');
                questionInfoContainer.classList.add('hidden');
                closeQuizButton.classList.add('hidden');
                return;
            }

            // Bestäm quizLängd baserat på valda radioknappen
            let selectedQuizCount = document.querySelector('input[name="quizCount"]:checked').value;
            if (selectedQuizCount === 'all') {
                quizLength = combinedQuestions.length;
            } else {
                quizLength = parseInt(selectedQuizCount, 10);
            }

            // Välj ett slumpmässigt urval av frågor från combinedQuestions
            const shuffledCombinedQuestions = [...combinedQuestions];
            shuffleArray(shuffledCombinedQuestions);
            // Se till att vi inte försöker ta fler frågor än vad som finns tillgängligt
            questions = shuffledCombinedQuestions.slice(0, Math.min(quizLength, shuffledCombinedQuestions.length)); 

            if (questions.length === 0) {
                 resultText.textContent = "Inga frågor att visa. Vänligen kontrollera quiz-datan.";
                 mainCardContainer.classList.add('hidden');
                 resultDisplayContainer.classList.remove('hidden');
                 questionInfoContainer.classList.add('hidden');
                 closeQuizButton.classList.add('hidden');
                 return;
            }

            startScreenContainer.classList.add('hidden');
            mainCardContainer.classList.remove('hidden');
            questionInfoContainer.classList.remove('hidden');
            resultDisplayContainer.classList.add('hidden');
            closeQuizButton.classList.remove('hidden'); // Visa stäng-knappen när quizet startar

            // Initialisera timern och visa den direkt
            timerSpan.textContent = '0:00';
            startTimer(); // Starta timern här när quizet börjar

            displayQuestion();
        }

        // Visar en specifik fråga
        async function displayQuestion() {
            if (currentQuestionIndex < questions.length) {
                const question = questions[currentQuestionIndex];

                try {
                    // Använd den specifika basePath för denna fråga
                    const svgResponse = await fetch(question.basePath + question.filename);
                    if (!svgResponse.ok) {
                        throw new Error(`Kunde inte ladda SVG-bild: ${question.filename} från ${question.basePath}, status: ${svgResponse.status}`);
                    }
                    let svgText = await svgResponse.text();

                    // Ta bort width, height, och stroke-width attributen från SVG-strängen.
                    // Ersätt sedan alla fill och stroke attribut med fill/stroke="currentColor" OM de INTE är "none".
                    svgText = svgText
                        .replace(/<svg([^>]*)width=['"].*?['"]([^>]*)>/g, '<svg$1$2>')
                        .replace(/<svg([^>]*)height=['"].*?['"]([^>]*)>/g, '<svg$1$2>')
                        .replace(/stroke-width=['"].*?['"]/g, ''); // Ta bort stroke-width från alla element

                    // Använd DOMParser för att manipulera SVG:n mer säkert
                    const parser = new DOMParser();
                    const svgDoc = parser.parseFromString(svgText, 'image/svg+xml');
                    const svgElement = svgDoc.documentElement;

                    // Sätt currentColor som standard för fyllning och linjer på element som inte är fill/stroke="none"
                    const elementsToColor = svgElement.querySelectorAll('*'); // Välj alla element för generell färgning

                    elementsToColor.forEach(el => {
                        const fill = el.getAttribute('fill');
                        const stroke = el.getAttribute('stroke');

                        if (fill !== null && fill.toLowerCase() !== 'none') {
                            el.setAttribute('fill', 'currentColor');
                        }
                        if (stroke !== null && stroke.toLowerCase() !== 'none') {
                            el.setAttribute('stroke', 'currentColor');
                        }
                    });

                    // Serialisera tillbaka till en sträng
                    const cleanedSvgCode = new XMLSerializer().serializeToString(svgElement);

                    questionSvgContainer.innerHTML = cleanedSvgCode;
                    questionSvgContainer.style.color = '#231F20'; // Tvinga färgen till #231F20 via currentColor

                } catch (error) {
                    console.error(`Fel vid laddning eller visning av SVG för ${question.filename}:`, error);
                    questionSvgContainer.innerHTML = `<p class="text-red-500">Kunde inte ladda bild för denna fråga.</p>`;
                }

                // Uppdatera frågenummer
                questionNumberSpan.textContent = `${currentQuestionIndex + 1}/${questions.length}`;

                // Rensa befintliga knappar
                answerButtonsContainer.innerHTML = '';

                // Skapa svarsalternativ
                let answerOptions = [];
                // Lägg till det korrekta svaret
                answerOptions.push({ text: question.answer, isCorrect: true });

                // Använd en kombinerad pool av svar för falska alternativ
                const combinedAnswerPool = [...allMainQuestionData, ...allExtraQuestionData]
                    .map(q => q.answer)
                    .filter((value, index, self) => self.indexOf(value) === index); // Filtrera bort dubbletter

                const incorrectAnswersPool = combinedAnswerPool
                    .filter(ans => ans !== question.answer); // Exkludera det korrekta svaret för den aktuella frågan

                shuffleArray(incorrectAnswersPool); // Blanda poolen av inkorrekta svar

                // Lägg till 3 unika inkorrekta svar, om tillgängliga
                let addedIncorrectAnswers = 0;
                for (let i = 0; i < incorrectAnswersPool.length && addedIncorrectAnswers < 3; i++) {
                    // Kontrollera att det inkorrekta svaret inte redan finns bland de valda alternativen
                    if (!answerOptions.some(opt => opt.text === incorrectAnswersPool[i])) {
                        answerOptions.push({ text: incorrectAnswersPool[i], isCorrect: false });
                        addedIncorrectAnswers++;
                    }
                }
                
                // Om det finns färre än 3 unika felaktiga svar (t.ex. om den totala poolen är liten), fyll på med generiska
                while (answerOptions.length < 4) { // Se till att vi alltid har 4 alternativ
                    const genericFiller = `Falskt Svar ${answerOptions.length + 1}`;
                    if (!answerOptions.some(opt => opt.text === genericFiller)) {
                        answerOptions.push({ text: genericFiller, isCorrect: false });
                    } else {
                        // Fallback om den generiska redan finns, lägg till slumpmässig sträng
                        answerOptions.push({ text: `Annat falskt svar ${Math.random().toFixed(4)}`, isCorrect: false });
                    }
                }


                shuffleArray(answerOptions); // Blanda alla svarsalternativ

                // Skapa knappar för alla svarsalternativ
                answerOptions.forEach(answer => {
                    const button = document.createElement('button');
                    button.classList.add('w-full', 'px-4', 'py-2', 'border', 'border-gray-400', 'bg-transparent', 'text-gray-700', 'font-semibold', 'rounded-md', 'hover:bg-gray-200', 'hover:text-black', 'focus:outline-none', 'focus:ring-2', 'focus:ring-gray-400', 'focus:ring-offset-2', 'transition', 'duration-150', 'ease-in-out');
                    button.textContent = answer.text;
                    button.dataset.isCorrect = answer.isCorrect;

                    button.addEventListener('click', () => handleAnswerClick(button, answer.isCorrect));
                    answerButtonsContainer.appendChild(button);
                });

            } else {
                showResults();
            }
        }

        // Hanterar klick på en svarsknapp
        function handleAnswerClick(clickedButton, isCorrect) {
            // Timern stoppas först vid showResults()

            // Inaktivera alla knappar för att förhindra flera klick
            Array.from(answerButtonsContainer.children).forEach(button => {
                button.disabled = true;
            });

            // Visa feedback (rött/grönt blixt)
            if (isCorrect) {
                score++;
                clickedButton.classList.add('flash-correct');
            } else {
                clickedButton.classList.add('flash-incorrect');
            }

            // Vänta lite efter blixten, sedan byt fråga eller visa resultat
            setTimeout(() => {
                currentQuestionIndex++;
                if (currentQuestionIndex < questions.length) {
                    displayQuestion();
                } else {
                    showResults(); // Visa resultat om alla frågor är besvarade
                }
            }, 1000); // Kort paus efter blixten
        }

        // Startar timern (körs en gång när quizet börjar)
        function startTimer() {
            if (!timerInterval) { // Se till att timern bara startar en gång
                timerInterval = setInterval(() => {
                    secondsElapsed++;
                    const minutes = Math.floor(secondsElapsed / 60);
                    const seconds = secondsElapsed % 60;
                    timerSpan.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }, 1000);
            }
        }

        // Stoppar timern
        function stopTimer() {
            clearInterval(timerInterval);
            timerInterval = null; // Återställ så att den kan startas igen
        }

        // Visar resultatskärmen
        function showResults() {
            stopTimer(); // Stoppa timern när quizet är slut

            const totalMinutes = Math.floor(secondsElapsed / 60);
            const totalSeconds = secondsElapsed % 60;
            const formattedTime = `${totalMinutes}:${totalSeconds < 10 ? '0' : ''}${totalSeconds}`;

            resultText.innerHTML = `
                <p>Total tid: ${formattedTime}</p>
                <p>${score} rätt av ${questions.length}</p>
            `;

            mainCardContainer.classList.add('hidden');
            resultDisplayContainer.classList.remove('hidden');
            questionInfoContainer.classList.add('hidden');
            closeQuizButton.classList.add('hidden'); // Dölj stäng-knappen vid resultat
        }

        // Eventlyssnare för "Starta"-knappen på startskärmen
        startButton.addEventListener('click', startQuiz);

        // Eventlyssnare för "Starta om"-knappen på resultatskärmen
        restartButton.addEventListener('click', init);

        // Eventlyssnare för stäng-knappen
        closeQuizButton.addEventListener('click', init);

        // Event listener for dark mode toggle
        darkModeToggle.addEventListener('click', () => {
            const isDark = document.documentElement.classList.contains('dark');
            setTheme(!isDark);
        });

        // Eventlyssnare för checkboxar för att uppdatera knappens tillstånd
        includeControlItemsCheckbox.addEventListener('change', updateStartButtonState);
        includeExtraPlacementCheckbox.addEventListener('change', updateStartButtonState);

        // Initiera startskärmen när sidan laddas
        document.addEventListener('DOMContentLoaded', () => {
            init();
            loadOrionLogo(); // Ladda Orion-loggan när DOM är redo

            // Alltid starta i light mode
            setTheme(false); 

            // Uppdatera startknappens tillstånd baserat på initiala checkbox-val
            updateStartButtonState();
        });
    </script>
</body>
</html>
